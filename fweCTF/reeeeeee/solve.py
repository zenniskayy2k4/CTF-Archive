# Bytecode từ file reeeeeee.py.txt
bytecode = [14, 4, 0, 0, 0, 4, 40, 0, 6, 0, 16, 102, 16, 119, 16, 101, 16, 99, 16, 116, 16, 102, 16, 123, 24, 16, 48, 48, 13, 11, 9, 0, 2214526978, 2281701374, 134217726, 0, 0, 0, 0, 0, 1, 16, 125, 6, 5, 1, 4, 39, 0, 6, 0, 23, 30, 0, 4294967295, 7, 5, 20, 99, 15, 22, 20, 16, 99, 4, 14, 0, 17, 0, 13, 6, 16, 116, 16, 48, 0, 17, 1, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 100, 15, 29, 27, 16, 100, 4, 21, 0, 17, 2, 7, 7, 16, 95, 16, 82, 15, 7, 5, 16, 49, 15, 2, 0, 17, 3, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 101, 15, 29, 27, 16, 101, 4, 21, 0, 17, 4, 7, 5, 16, 99, 15, 9, 7, 16, 88, 16, 120, 15, 2, 0, 17, 5, 1, 15, 2, 0, 18, 6, 5, 1, 4, 39, 0, 6, 0, 23, 30, 0, 4294967295, 7, 5, 20, 102, 15, 22, 20, 16, 102, 4, 14, 0, 17, 6, 13, 6, 16, 119, 16, 123, 0, 17, 7, 1, 15, 2, 0, 18, 6, 5, 1, 4, 48, 0, 6, 0, 23, 39, 0, 4294967295, 7, 5, 20, 104, 15, 31, 29, 16, 104, 4, 23, 0, 17, 8, 7, 7, 16, 49, 16, 63, 15, 9, 7, 16, 95, 16, 68, 15, 2, 0, 17, 9, 1, 15, 2, 0, 18, 6, 5, 1, 4, 32, 0, 6, 0, 23, 23, 0, 4294967295, 7, 5, 20, 108, 15, 15, 13, 16, 108, 4, 7, 0, 16, 51, 16, 100, 1, 15, 2, 0, 18, 6, 5, 1, 4, 30, 0, 6, 0, 23, 21, 0, 4294967295, 7, 5, 20, 109, 15, 13, 11, 16, 109, 4, 5, 0, 16, 66, 1, 15, 2, 0, 18, 6, 5, 1, 4, 48, 0, 6, 0, 23, 39, 0, 4294967295, 7, 5, 20, 112, 15, 31, 29, 16, 112, 4, 23, 0, 17, 10, 7, 7, 16, 49, 16, 108, 15, 9, 7, 16, 114, 16, 52, 15, 2, 0, 17, 11, 1, 15, 2, 0, 18, 6, 5, 1, 4, 55, 0, 6, 0, 23, 46, 0, 4294967295, 7, 5, 20, 114, 15, 38, 36, 16, 114, 4, 30, 0, 17, 12, 7, 7, 16, 95, 16, 100, 15, 16, 7, 16, 83, 16, 101, 15, 9, 7, 16, 52, 16, 95, 15, 2, 0, 17, 13, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 115, 15, 29, 27, 16, 115, 4, 21, 0, 17, 14, 7, 7, 16, 83, 16, 52, 15, 7, 5, 16, 51, 15, 2, 0, 17, 15, 1, 15, 2, 0, 18, 6, 5, 1, 4, 30, 0, 6, 0, 23, 21, 0, 4294967295, 7, 5, 20, 116, 15, 13, 11, 16, 116, 4, 5, 0, 16, 102, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 117, 15, 29, 27, 16, 117, 4, 21, 0, 17, 16, 7, 5, 16, 115, 15, 9, 7, 16, 83, 16, 52, 15, 2, 0, 17, 17, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 119, 15, 29, 27, 16, 119, 4, 21, 0, 17, 18, 7, 5, 16, 101, 15, 9, 7, 16, 104, 16, 49, 15, 2, 0, 17, 19, 1, 15, 2, 0, 18, 6, 5, 1, 4, 32, 0, 6, 0, 23, 23, 0, 4294967295, 7, 5, 20, 120, 15, 15, 13, 16, 120, 4, 7, 0, 16, 88, 16, 33, 1, 15, 2, 0, 18, 6, 5, 1, 4, 30, 0, 6, 0, 23, 21, 0, 4294967295, 7, 5, 20, 66, 15, 13, 11, 16, 66, 4, 5, 0, 16, 33, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 68, 15, 29, 27, 16, 68, 4, 21, 0, 17, 20, 7, 7, 16, 49, 16, 115, 15, 7, 5, 16, 95, 15, 2, 0, 17, 21, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 69, 15, 29, 27, 16, 69, 4, 21, 0, 17, 22, 7, 5, 16, 114, 15, 9, 7, 16, 95, 16, 119, 15, 2, 0, 17, 23, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 77, 15, 29, 27, 16, 77, 4, 21, 0, 17, 24, 7, 5, 16, 112, 15, 9, 7, 16, 120, 16, 66, 15, 2, 0, 17, 25, 1, 15, 2, 0, 18, 6, 5, 1, 4, 32, 0, 6, 0, 23, 23, 0, 4294967295, 7, 5, 20, 82, 15, 15, 13, 16, 82, 4, 7, 0, 16, 51, 16, 57, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 83, 15, 29, 27, 16, 83, 4, 21, 0, 17, 26, 7, 5, 16, 52, 15, 9, 7, 16, 115, 16, 51, 15, 2, 0, 17, 27, 1, 15, 2, 0, 18, 6, 5, 1, 4, 48, 0, 6, 0, 23, 39, 0, 4294967295, 7, 5, 20, 85, 15, 31, 29, 16, 85, 4, 23, 0, 17, 28, 7, 7, 16, 95, 16, 117, 15, 9, 7, 16, 49, 16, 63, 15, 2, 0, 17, 29, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 88, 15, 29, 27, 16, 88, 4, 21, 0, 17, 30, 7, 5, 16, 120, 15, 9, 7, 16, 33, 16, 95, 15, 2, 0, 17, 31, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 48, 15, 29, 27, 16, 48, 4, 21, 0, 17, 32, 7, 5, 16, 77, 15, 9, 7, 16, 49, 16, 82, 15, 2, 0, 17, 33, 1, 15, 2, 0, 18, 6, 5, 1, 4, 56, 0, 6, 0, 23, 47, 0, 4294967295, 7, 5, 20, 49, 15, 39, 37, 16, 49, 4, 31, 0, 17, 34, 7, 5, 16, 108, 15, 19, 5, 16, 63, 15, 14, 7, 16, 115, 16, 83, 15, 7, 5, 16, 68, 15, 2, 0, 17, 35, 1, 15, 2, 0, 18, 6, 5, 1, 4, 56, 0, 6, 0, 23, 47, 0, 4294967295, 7, 5, 20, 51, 15, 39, 37, 16, 51, 4, 31, 0, 17, 36, 7, 7, 16, 100, 16, 95, 15, 17, 5, 16, 57, 15, 12, 5, 16, 109, 15, 7, 5, 16, 63, 15, 2, 0, 17, 37, 1, 15, 2, 0, 18, 6, 5, 1, 4, 32, 0, 6, 0, 23, 23, 0, 4294967295, 7, 5, 20, 52, 15, 15, 13, 16, 52, 4, 7, 0, 16, 83, 16, 115, 1, 15, 2, 0, 18, 6, 5, 1, 4, 32, 0, 6, 0, 23, 23, 0, 4294967295, 7, 5, 20, 57, 15, 15, 13, 16, 57, 4, 7, 0, 16, 101, 16, 88, 1, 15, 2, 0, 18, 6, 5, 1, 4, 48, 0, 6, 0, 23, 39, 0, 4294967295, 7, 5, 20, 123, 15, 31, 29, 16, 123, 4, 23, 0, 17, 38, 7, 7, 16, 99, 16, 48, 15, 9, 7, 16, 51, 16, 102, 15, 2, 0, 17, 39, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 33, 15, 29, 27, 16, 33, 4, 21, 0, 17, 40, 7, 7, 16, 95, 16, 119, 15, 7, 5, 16, 69, 15, 2, 0, 17, 41, 1, 15, 2, 0, 18, 6, 5, 1, 4, 46, 0, 6, 0, 23, 37, 0, 4294967295, 7, 5, 20, 63, 15, 29, 27, 16, 63, 4, 21, 0, 17, 42, 7, 7, 16, 104, 16, 95, 15, 7, 5, 16, 125, 15, 2, 0, 17, 43, 1, 15, 2, 0, 18, 6, 5, 1, 4, 68, 0, 6, 0, 23, 59, 0, 4294967295, 7, 5, 20, 95, 15, 51, 49, 16, 95, 4, 43, 0, 17, 44, 7, 5, 16, 82, 15, 31, 7, 16, 119, 16, 104, 15, 24, 7, 16, 68, 16, 49, 15, 17, 5, 16, 100, 15, 12, 5, 16, 85, 15, 7, 5, 16, 117, 15, 2, 0, 17, 45, 1, 15, 2, 0, 18, 6, 5, 1, 1]

# Các hằng số opcode quan trọng được suy ra từ bytecode
LITERAL = 16
SUBPATTERN = 46 # Đây là SUBPATTERN_CALL, nhưng dường như được dùng thay thế
GROUPREF = 15
BRANCH = 30
JUMP = 18
SUCCESS = 1

# Tìm tất cả các khối SUBPATTERN, mỗi khối tương ứng với một ký tự cần giải.
# Thử cả hai giá trị opcode có thể có cho SUBPATTERN (4 và 46)
subpattern_starts = []
ip = bytecode.index(123) + 1  # Bắt đầu tìm kiếm sau 'fwectf{'
while ip < len(bytecode):
    # Dựa vào cấu trúc, SUBPATTERN thực tế được dùng có giá trị là 4.
    if bytecode[ip] == 4:
        subpattern_starts.append(ip)
    ip += 1

# rules[group_id] = {'conditions': [...], 'default': 'x'}
rules = {}

# Gán group_id (1, 2, 3,...) cho các khối SUBPATTERN tìm được
for i, start_pos in enumerate(subpattern_starts):
    group_id = i + 1
    rules[group_id] = {'conditions': [], 'default': None}
    
    # Header của một khối là 6 words: SUBPATTERN (4) + MARK (2)
    ip = start_pos + 4 # SUBPATTERN có 4 args, nên bắt đầu từ ip+4

    # Vòng lặp để phân tích các quy tắc bên trong một subpattern
    while True:
        if ip >= len(bytecode) or bytecode[ip] == SUCCESS:
            break

        current_opcode = bytecode[ip]
        
        if current_opcode == BRANCH:
            branch_offset = bytecode[ip + 1]
            parse_ip = ip + 2 

            # Phân tích một nhánh điều kiện
            dep_group = bytecode[parse_ip + 1]
            parse_ip += 2
            
            in_jump = bytecode[parse_ip + 1]
            dep_chars = []
            in_ip = parse_ip + 2 
            while in_ip < parse_ip + in_jump:
                if bytecode[in_ip] == LITERAL:
                    dep_chars.append(chr(bytecode[in_ip + 1]))
                in_ip += 2
            parse_ip += in_jump

            target_char = chr(bytecode[parse_ip + 1])
            
            rules[group_id]['conditions'].append((dep_group, dep_chars, target_char))
            
            ip += branch_offset

        elif current_opcode == LITERAL:
            # Nhánh mặc định (else) hoặc nhánh duy nhất
            target_char = chr(bytecode[ip + 1])
            rules[group_id]['default'] = target_char
            # Sau nhánh mặc định, logic của subpattern này kết thúc
            break

        else:
            # Gặp các opcode khác (như JUMP, MARK...), bỏ qua chúng
            # Hầu hết các opcode này có 1 argument
            ip += 2


# Giải các ràng buộc để tìm flag
flag_chars = {}

for group_id in sorted(rules.keys()):
    found_match = False
    
    # Thử các quy tắc có điều kiện trước
    for dep_group, dep_chars, target_char in rules[group_id]['conditions']:
        if dep_group in flag_chars and flag_chars[dep_group] in dep_chars:
            flag_chars[group_id] = target_char
            found_match = True
            break
            
    # Nếu không có điều kiện nào khớp, sử dụng quy tắc mặc định
    if not found_match:
        flag_chars[group_id] = rules[group_id]['default']

# Ghép lại thành flag hoàn chỉnh
content = "".join([flag_chars[i] for i in sorted(flag_chars.keys())])
flag = f"fwectf{{{content}}}"
print(f"[*] Found flag: {flag}")