from math import isqrt

def factor_with_xor(n: int, x: int):
    """Recover p,q from n = p*q and x = p ^ q using bit-by-bit DP."""
    nbits = n.bit_length()
    cands = [0]  # các khả năng cho p (phần thấp tới bit i)
    for i in range(nbits):
        mask = (1 << (i + 1)) - 1
        target_low = n & mask
        x_low = x & mask
        new = []
        for p_low in cands:
            # thử bit i của p là 0 hoặc 1
            for b in (0, 1):
                p_cand = p_low | (b << i)
                q_low = p_cand ^ x_low
                prod_low = (p_cand * q_low) & mask
                if prod_low == target_low:
                    new.append(p_cand)
        # khử trùng lặp để không phình nhánh
        cands = list(set(new))
        if not cands:
            raise ValueError("No candidates left; inputs may be inconsistent.")
        # (thực tế số lượng ứng viên thường rất nhỏ, thường chỉ 1)
    # chọn ứng viên đúng là ước của n
    for p in cands:
        if p != 0 and n % p == 0:
            q = n // p
            if (p ^ q) == x:
                return (p, q) if p < q else (q, p)
    # đôi khi p đã là q, hoặc cần đảo lại kiểm tra
    for p in cands:
        q = n // p if p and n % p == 0 else None
        if q and (p ^ q) == x:
            return (p, q) if p < q else (q, p)
    raise ValueError("Failed to factor n with given xor.")

def recover_flag(xor_flag_p: int, xor_flag_q: int, e: int, n: int, c: int):
    X = xor_flag_p ^ xor_flag_q  # = p ^ q
    p, q = factor_with_xor(n, X)
    phi = (p - 1) * (q - 1)
    d = pow(e, -1, phi)
    m = pow(c, d, n)
    # đổi m -> bytes (giữ nguyên chiều dài tối thiểu)
    m_bytes = m.to_bytes((m.bit_length() + 7) // 8, 'big')
    # trích flag dạng LITCTF{...}
    start = m_bytes.find(b"LITCTF{")
    flag = None
    if start != -1:
        end = m_bytes.find(b"}", start)
        if end != -1:
            flag = m_bytes[start:end+1]
    return {
        "p": p, "q": q, "d": d,
        "message_bytes": m_bytes,
        "flag": flag.decode() if flag else None
    }

# --- ví dụ dùng ---
# điền các giá trị in ra từ đề:
xor_flag_p = 101670196162694941502427171631547606851112406045903792705981470176636073716642873439691771552202674600421424873701622587833368473775352451569627505930677839061275705754168080457459109162728726699047858076083419098031469555053793093677256747961766999578241953513667144316639045820125314211814686805370288897777
xor_flag_q = 154851176977202900786926789835741020113661817258544234930253485046404096702359518884690819974295552368471004974907554889661102920475882676182239456251790144049768807022310239000609713593462951985029796820144338165822511789753563851765084759333335649709013904357043199947084736990867727119391635554469203851475
e = 65537
n = 15743749539296409634663424121280780137241091382693667702428459710350799988364206067386721771957566782759869049232956203164038880156911093552224029889115066342065167950865082886553987387676830751986436049339135431329680104325633680830079626081064732539895004309746439339464459693383082656000036207580730478400742945792833119299470608434720699402585565729587072933594242753293708783340966330892945616957505604652405874136389552304994271320951778239892061518891595360471182332599388638905448501774287058774862731780749187489445130626995755810843627861024383386053591739555428660621596009796747521186540907587626526354979
c = 12491836572962371142912282526183127727810656873590190425245785755657824188572673282961267547498047057210511062769831432369500290082201857396565408750352351543012886063444497424615003883561616832167695054390558710127993311210853140764124864296465385292710205643457867576411539976373834717774524372800479033107508821194896373692624595254898666506264112777765252113430017855611502581490202858417963632613437432687915848968245199677118497551570325887072465495707221049328722964725770453905598509057761866855367553451143328933691106648479112828467589560097547277553370387876691619654430290953524337362605508524920790321372
result = recover_flag(xor_flag_p, xor_flag_q, e, n, c)
print("flag:", result["flag"])