from Crypto.Util.number import long_to_bytes, bytes_to_long
from Crypto.Util.Padding import unpad

# Các giá trị từ file output.txt
e = 65537
n = 28720310163698579785590409431244488502590518896114002560615035101872706254575673226701273452266044763379371347175490772833687557638193161203442701390842338726680883158060043516615180759468749002859934101042225109339060841430076215460950001496422014817369538803906181940671644497607497588494548107578139030246710304659121835681466614082387895636652987625506231425635937025960541486880824071903428563319272223449602650009455406871550491147456125891228766395361048688453313744200332284228661669385987688182529904303370060855844163590429388043008170533746319606379457862846257781629063966348729803646974228947658975816397
enc = 28622274173454751770425162522510657578255182655076851217407818429087697323190577802242456771214850549746446507706653313042057593379659705765532892268852740105589258308684132958276551073639787381340659764512440431614091062678114371089265383600952938737174680538339955267319021442184851847628241496769952842522557307346991056557448136450999928593799714420370025506694266924139490626538253626051572437799338532577579795987845669725423644191131632856219518165150234626040583326103289158950261130615392010672381664407880524072421107969847707990340309409099437843249519731209835667579473831944170863554281708120873440754999
sign = 13347520343804927847619065202065217836879984453006249407611353191409157302332065972903532015282229744284677309671725411375707706894638641694057135257768299781877077021376667459594883760258356475573151469487363169214012061817199685037363785333516662036329205820120312268834684818014608203312923165179884189461072393686643809307452885991065622646622558149438096015921040528472490412757534851295013865651002130260213027431057502650933677854772978321133895346051674016006963172506825876634054025209746366903230914159762719784407670815205227721887604953882373776567997690485937876918420481954105325928897076354153411410671

# Bước 1: Khôi phục lại hash của flag (h) từ chữ ký (sign)
# Ta có sign = h^d mod n, suy ra sign^e = (h^d)^e = h mod n
h = pow(sign, e, n)
print(f"[*] Khôi phục được giá trị số của hash: {h}")

# Bước 2: Chuyển h về dạng bytes
# Số bytes của h phải bằng số bytes của n (256 bytes)
padded_flag = long_to_bytes(h, 256)
print(f"[*] Chuyển thành chuỗi bytes đã được pad: {padded_flag}")

# Bước 3: Loại bỏ padding (unpad) để lấy lại flag gốc
# Hàm pad trong gen.py là pad theo chuẩn PKCS#7 với block_size = 256
try:
    flag_bytes = unpad(padded_flag, 256)
    flag = flag_bytes.decode()
    print(f"Flag: {flag}")

    # Bước 4 (tùy chọn): Xác minh lại flag
    print("\n[*] Đang xác minh lại flag...")
    re_enc = pow(bytes_to_long(flag_bytes), e, n)
    if re_enc == enc:
        print("[+] Xác minh thành công! Bản mã hóa của flag tìm được khớp với `enc` đã cho.")
    else:
        print("[-] Xác minh thất bại. Có lỗi gì đó đã xảy ra.")

except ValueError as e:
    print(f"\n[!] Lỗi khi unpad: {e}")
    print("[!] Có thể giá trị `h` khôi phục được không đúng hoặc có lỗi trong quá trình chuyển đổi.")