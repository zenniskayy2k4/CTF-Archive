#!/usr/bin/env python3
from pwn import *
import re

# Các tham số công khai từ mã nguồn (đã sửa lỗi copy-paste trong p)
q = 5243100801794109929281462428701419635366748605688391110666846440390623893783262628523761587391565330829014535160645164909748037099168806766827747073574767
p = 48343876239256152204683265137957865106600250727129085205195481753702547435390353846340524668700835912830150728438081680783005019335252282704175183705550633710021256624526088570233776510191099204023509942604838312800504709348675136004632144324484984015737283586427593105320189424560143199548356658899558380302939462440933153590998211780474198886385993191394681783235762511784528547014672995566024070645290525722726514088459723487485247049865277545571588756066396398019375920789530253409907965259913929254549803328440274579561996381702317025977225125802563365214504505151535802037452499244685576772498317787586163912621261061118094662923213218230683241657690726979145768175542070326934379343714418348715111937057643159443937278679178306050419670139339900726594462764019270932110436679550618341774347437172452082229950142262778614258262707515081186426197795593239027351995821159393151749431480918635040861011647158143839516063264879676330302647859040384360918671681176484974181205899835391134273395035328609578385611576741161149291944391444036680608467437243926389670722622273342098319968588888008057595186010656951228035502839040712417994426769143158609275408829530977821831479372927630306630036095999794044948630251779663789573307349
g = 27077907211094407352064005617149740823920460802361454284917938487595038486843919694879860227804163617163887196346615581125110316810341187288015225010937279700996289427765551903377911228644717147748376916745452663405500727801264645812122707279656366873327911999058007765901529378288353761535726059354695669857072266079723601250734386283611961063780221404409539850114773327346048196639745735290251466914062124309890905456849931071705888299175329578259771638130426663089181608550198954557760128498382275176052928628784544598731471214052229920466795969690561266334080549240718265323563969916398250637282258584478821148922087453460544136336826498447493811251927572287019625824762167197707094586776148343493294093776308129679991366957851634992727179396393080498928014576998011585856828351913032729306347556345237877418604256669235214795655575611060090785352725700612450736184001125935501905371392751366379903244484702211593250176291205192686280233834281418586583546574099876165216483538096685334870309514133883844889124190924330097898977198452377785041264683674104484697279191478765400880229563679659404040117670752841736259156239759204126841107069781580466206951403530087144439756848320270358657115351360696610028990606425058610142963589

def bytes_to_int(b):
    return int.from_bytes(b, 'big')

conn = remote("challenge.secso.cc", 7003)
intro = conn.recvuntil(b")\n").decode()
match = re.search(r'\((\d+), (\d+)\)', intro)
r_k = int(match.group(1))
s_k = int(match.group(2))

m_k_bytes = b"krishtilani"
m_k = bytes_to_int(m_k_bytes)
m_i_bytes = b"Ixbixbam\x00\x00\x00"
m_i = bytes_to_int(m_i_bytes)

# --- Bước 1: Tính phần thấp của khóa, x_prime ---
log.info("Calculating the lower part of the key (x_prime)...")
diff = (s_k - r_k) % q
diff_inv = pow(diff, -1, q)
x_prime = (m_k * diff_inv) % q
log.success(f"Found x_prime = {x_prime}")

# --- Bước 2: Brute-force n để tìm khóa bí mật đầy đủ ---
log.info("Bruteforcing 'n' to find the full private key...")
x = -1
w_k = pow(s_k, -1, q)
u1_k = (m_k * w_k) % q
u2_k = (r_k * w_k) % q

for n in range(4):
    log.info(f"Testing n = {n}...")
    x_cand = n * q + x_prime
    y_cand = pow(g, x_cand, p)
    
    # Kiểm tra lại chữ ký gốc với y_cand
    v = (pow(g, u1_k, p) * pow(y_cand, u2_k, p)) % p % q
    
    if v == r_k:
        x = x_cand
        log.success(f"Found the full private key with n={n}!")
        log.success(f"x = {x}")
        break

if x == -1:
    log.failure("Could not recover the full private key. The x=k assumption was wrong.")
    exit()

# --- Bước 3: Ký thông điệp "Ixbixbam" với khóa x đã biết ---
log.info("Signing 'Ixbixbam' with the recovered private key...")
k_new = 1337 
r_i = pow(g, k_new, p) % q
s_i = (pow(k_new, -1, q) * (m_i + x * r_i)) % q

log.success(f"Forged r_i: {r_i}")
log.success(f"Forged s_i: {s_i}")

# --- Bước 4: Tương tác với server ---
conn.recvuntil(b"Now, enter your name:\n")
conn.send(b"Ixbixbam")
log.info("Sent name: Ixbixbam")

conn.recvuntil(b"Enter r:\n")
conn.sendline(str(r_i).encode())
log.info("Sent forged r")

conn.recvuntil(b"Enter s:\n")
conn.sendline(str(s_i).encode())
log.info("Sent forged s")

conn.interactive()