#include <unistd.h>
#include <gmp.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <initializer_list>

using namespace std;

void get_random_number(mpz_t number, int bit_size) {
    int byte_size = (bit_size + 7) / 8; // ehhh i should probably restrict it properly to the bit size properly buuuuuut ceeeeebs we only use a power of 2 anyway
    FILE *urandom;
    if ((urandom = fopen("/dev/urandom", "r")) == NULL) {
        perror("fopen");
    }

    char *number_bytes = (char *)malloc(byte_size * sizeof(*number_bytes));
    fread(number_bytes, 1, byte_size, urandom);
    
    mpz_import(number, byte_size, 1, 1, 0, 0, number_bytes);
}

template <typename... mpz_type>
void init_all(mpz_type... vals) {
    for (const auto val : {vals...}) {
        mpz_init(val);
    }
}

int main(void) {
    mpz_t q;
    mpz_t p;
    mpz_t g;
    mpz_t x;
    mpz_t y;
    mpz_t k;
    mpz_t kr;
    mpz_t ks;
    mpz_t m;
    mpz_t r;
    mpz_t s;
    mpz_t w;
    mpz_t v1;
    mpz_t v2;

    init_all(q, p, g, x, y, k, kr, ks, m, r, s, w, v1, v2);


    mpz_set_str(q,
        "5243100801794109929281462428701419635366748605688391110666846440390623893783262628523761587391565330829014535160645164909748037099168806766827747073574767",
        10);
    mpz_set_str(p,
        "48343876239256152204683265137957865106600250727129085205195481753702547435390353846340524668700835912830150728438081680783005019335252282704175183705550633710021256624526088570233776510191099204023509942604838312800504709348675136004632144324484984015737283586427593105320189424560143199548356658899558380302939462440933153590998211780474198886385993191394681783235762511784528547014672995566024070645290525722726514088459723487485247049865277545571588756066396398019375920789530253409907965259913929254549803328440274579561996381702317025977225125802563365214504505151535802037452499244685576772498317787586163912621261061118094662923213218230683241657690726979145768175542070326934379343714418348715111937057643159443937278679178306050419670139339900726594462764019270932110436679550618341774347437172452082229950142262778614258262707515081186426197795593239027351995821159393151749431480918635040861011647158143839516063264879676330302647859040384360918671681176484974181205899835391134273395035328609578385611576741161149291944391444036680608467437243926389670722622273342098319968588888008057595186010656951228035502839040712417994426769143158609275408829530977821831479372927630306630036095999794044948630251779663789573307349",
        10);
    mpz_set_str(g,
        "27077907211094407352064005617149740823920460802361454284917938487595038486843919694879860227804163617163887196346615581125110316810341187288015225010937279700996289427765551903377911228644717147748376916745452663405500727801264645812122707279656366873327911999058007765901529378288353761535726059354695669857072266079723601250734386283611961063780221404409539850114773327346048196639745735290251466914062124309890905456849931071705888299175329578259771638130426663089181608550198954557760128498382275176052928628784544598731471214052229920466795969690561266334080549240718265323563969916398250637282258584478821148922087453460544136336826498447493811251927572287019625824762167197707094586776148343493294093776308129679991366957851634992727179396393080498928014576998011585856828351913032729306347556345237877418604256669235214795655575611060090785352725700612450736184001125935501905371392751366379903244484702211593250176291205192686280233834281418586583546574099876165216483538096685334870309514133883844889124190924330097898977198452377785041264683674104484697279191478765400880229563679659404040117670752841736259156239759204126841107069781580466206951403530087144439756848320270358657115351360696610028990606425058610142963589",
        10);

    mpz_import(m, 11, 1, 1, 0, 0, "krishtilani");

    get_random_number(x, 512);
    mpz_powm_sec(y, g, x, p); // keep this secret!



    get_random_number(k, 512);
    mpz_powm_sec(kr, g, k, p);
    mpz_mod(kr, kr, q);
    mpz_invert(w, k, q);
    mpz_mul(ks, kr, x);
    mpz_add(ks, ks, m);
    mpz_mul(ks, ks, w);
    mpz_mod(ks, ks, q);
    
    puts("I've only got one friend");
    gmp_printf("Here is a signature for \"krishtilani\": (%Zd, %Zd)\n", kr, ks);

    puts("Now, enter your name:");
    char name[12] = {0};
    read(0, name, 11);
    mpz_import(m, 11, 1, 1, 0, 0, name);

    puts("Enter r:");
    gmp_scanf("%Zd", r);

    puts("Enter s:");
    gmp_scanf("%Zd", s);

    mpz_invert(w, s, q);
    mpz_mul(v1, m, w);
    mpz_mul(v2, r, w);
    mpz_powm_sec(v1, g, v1, p);
    mpz_powm_sec(v2, y, v2, p);
    mpz_mul(v1, v1, v2);
    mpz_mod(v1, v1, p);
    mpz_mod(v1, v1, q);

    if (mpz_cmp(v1, r) != 0) {
        puts("Invalid signature!");
    } else if (strcmp("Ixbixbam", name) != 0) {
        puts("Sorry, you're not my friend!");
    } else {
        puts("oh hey K17{REDACTED}");
    }
}