# -*- coding: utf-8 -*-


# This file was *autogenerated* from the file solve.sage
from sage.all_cmdline import *   # import sage library

_sage_const_1 = Integer(1); _sage_const_2 = Integer(2); _sage_const_513 = Integer(513); _sage_const_1026 = Integer(1026); _sage_const_4 = Integer(4); _sage_const_0 = Integer(0); _sage_const_1356778572733072598899117810387249992574522959164660158978261227599306176195384005969103511885035609949864172916964471191743757298897353816579670563539875819406755622758747955982682367539947525616869384734991449523877021132573181857999476082561104420234106903004966701754408244596159613231661548456086163263848433784964901263660769495022790237388501738303494952427153400024710233813497481386982324358968302813838873795431503674379336123877734986831464076597403964553322683446687149717152655797447364938904177713967356511806145361371106284104812683802090280022366316857295933966015935354011435976628458981967283127983 = Integer(1356778572733072598899117810387249992574522959164660158978261227599306176195384005969103511885035609949864172916964471191743757298897353816579670563539875819406755622758747955982682367539947525616869384734991449523877021132573181857999476082561104420234106903004966701754408244596159613231661548456086163263848433784964901263660769495022790237388501738303494952427153400024710233813497481386982324358968302813838873795431503674379336123877734986831464076597403964553322683446687149717152655797447364938904177713967356511806145361371106284104812683802090280022366316857295933966015935354011435976628458981967283127983); _sage_const_9235259145423256892122147278594405629385984689635295048952338767588488293611241423612199983175016428878909516499589565756753383793998080125165071232140317910880708917414368477930319585713224345586241703538960089588377048023270838450395698917623646654837556124054011784700397196315415041979923778359687545152111655059718006961990186440609454588036329862232531990445883821442518635909212877134474497367702431138917507977283128545885053360665857628397214947463838495849081554623821639921833412395428405488575665432752447137325585168763830506567729788349487049486040780771779645494959821109054275642976547125233126064705 = Integer(9235259145423256892122147278594405629385984689635295048952338767588488293611241423612199983175016428878909516499589565756753383793998080125165071232140317910880708917414368477930319585713224345586241703538960089588377048023270838450395698917623646654837556124054011784700397196315415041979923778359687545152111655059718006961990186440609454588036329862232531990445883821442518635909212877134474497367702431138917507977283128545885053360665857628397214947463838495849081554623821639921833412395428405488575665432752447137325585168763830506567729788349487049486040780771779645494959821109054275642976547125233126064705); _sage_const_26655408169980069210647581523602779478383892791339633948356189966966764750165134594036664344616717049933468489628650785388326960151667345490717171048101455362566962665238961659030316534689141077384698564134139632695609188803626466763599399566394268096308569815703206388042056345258250386433839660150434400832811052444460080481324647584218234188638113017330573479354360529764080129533591285518499302216709805065611198775844489705004103428358877462001690093040584862237132523022766091068430370508379474771150405568772531525628897113571198108361167861758593933680578287574630561945653761414928747417980154682790756164343 = Integer(26655408169980069210647581523602779478383892791339633948356189966966764750165134594036664344616717049933468489628650785388326960151667345490717171048101455362566962665238961659030316534689141077384698564134139632695609188803626466763599399566394268096308569815703206388042056345258250386433839660150434400832811052444460080481324647584218234188638113017330573479354360529764080129533591285518499302216709805065611198775844489705004103428358877462001690093040584862237132523022766091068430370508379474771150405568772531525628897113571198108361167861758593933680578287574630561945653761414928747417980154682790756164343)# sage

from Crypto.Util.number import long_to_bytes
from sage.all import Integer, PolynomialRing, power_mod, ZZ, QQ, Matrix

def solve_challenge(c_py, e_py, n_py):
    print("\n[+] Bắt đầu tấn công Boneh-Durfee (triển khai tự chứa)...")

    c = Integer(c_py)
    e = Integer(e_py)
    n = Integer(n_py)

    # 1. Xây dựng đa thức trên vành số nguyên
    P_ZZ = PolynomialRing(ZZ, names=('x', 'y',)); (x, y,) = P_ZZ._first_ngens(2)
    pol = x * (n - y) + _sage_const_1 

    # 2. Đặt giới hạn và tham số
    X = _sage_const_2 **_sage_const_513 
    Y = _sage_const_2 **_sage_const_1026 
    m = _sage_const_4 
    
    # 3. Xây dựng ma trận
    print("[+] Đang xây dựng ma trận cho dàn...")
    
    shifts = []
    monomials = []
    for i in range(m + _sage_const_1 ):
        for j in range(m - i + _sage_const_1 ):
            g = x**i * pol**j * e**(m-j)
            shifts.append(g)
            for k in range(g.degree(x) + _sage_const_1 ):
                for l in range(g.degree(y) + _sage_const_1 ):
                    monomials.append(x**k * y**l)
    
    monomials = sorted(list(set(monomials)))
    dim = len(monomials)
    B = Matrix(ZZ, len(shifts), dim)

    for i, g in enumerate(shifts):
        for j, mon in enumerate(monomials):
            B[i, j] = g.coefficient(mon) * mon(X, Y)

    # 4. Áp dụng LLL
    print("[+] Đang chạy thuật toán LLL (có thể mất vài phút)...")
    B_LLL = B.LLL()

    # 5. Tìm nghiệm từ các vector ngắn
    print("[+] LLL hoàn tất. Đang tìm nghiệm từ các vector ngắn...")
    
    # === SỬA LỖI TYPEERROR TẠI ĐÂY ===
    # Tạo một vành đa thức mới trên các số hữu tỉ (QQ)
    P_QQ = PolynomialRing(QQ, names=('x_q', 'y_q',)); (x_q, y_q,) = P_QQ._first_ngens(2)
    
    # Chuyển 2 vector ngắn nhất thành đa thức trong vành QQ
    q1 = _sage_const_0 
    q2 = _sage_const_0 
    for i in range(dim):
        # Lấy lại đơn thức từ chỉ số cột
        mon = monomials[i]
        # Xây dựng đa thức với hệ số hữu tỉ
        q1 += B_LLL[_sage_const_0 ][i] / mon(X, Y) * mon(x_q, y_q)
        q2 += B_LLL[_sage_const_1 ][i] / mon(X, Y) * mon(x_q, y_q)
    # =================================

    # 6. Sử dụng Resultant để loại bỏ biến y_q (từ vành QQ)
    res = q1.resultant(q2, y_q)
    
    # 7. Tìm nghiệm nguyên của đa thức một biến
    k_roots = res.roots(ring=ZZ)

    if not k_roots:
        print("[-] Không tìm thấy nghiệm nguyên nào cho k.")
        return

    print(f"[+] Tìm thấy {len(k_roots)} ứng cử viên cho k. Đang kiểm tra...")
    for k_sol, _ in k_roots:
        k = Integer(k_sol)
        if k == _sage_const_0 : continue

        # 8. Tìm s, d và giải mã
        f_s = q1.subs({x_q: k})
        s_roots = f_s.roots(ring=ZZ)
        
        for s_sol, _ in s_roots:
            s = Integer(s_sol)
            
            phi_candidate = n - s
            if phi_candidate > _sage_const_0  and (_sage_const_1  + k * phi_candidate) % e == _sage_const_0 :
                d_candidate = (_sage_const_1  + k * phi_candidate) // e
                try:
                    m = power_mod(c, d_candidate, n)
                    flag_bytes = long_to_bytes(int(m))
                    if b'SECSO' in flag_bytes:
                        print(f"\n[+] TẤN CÔNG THÀNH CÔNG!")
                        print(f"    - Tìm thấy k = {k}")
                        print(f"    - Tìm thấy s = {s}")
                        print(f"    - Khóa bí mật d = {d_candidate}")
                        print("\n[+] FLAG:")
                        print(flag_bytes.rstrip(b'\x00').decode())
                        return
                except Exception:
                    continue

    print("\n[-] Đã thử tất cả các nghiệm nhưng không tìm thấy flag.")

def main():
    c = _sage_const_1356778572733072598899117810387249992574522959164660158978261227599306176195384005969103511885035609949864172916964471191743757298897353816579670563539875819406755622758747955982682367539947525616869384734991449523877021132573181857999476082561104420234106903004966701754408244596159613231661548456086163263848433784964901263660769495022790237388501738303494952427153400024710233813497481386982324358968302813838873795431503674379336123877734986831464076597403964553322683446687149717152655797447364938904177713967356511806145361371106284104812683802090280022366316857295933966015935354011435976628458981967283127983 
    e = _sage_const_9235259145423256892122147278594405629385984689635295048952338767588488293611241423612199983175016428878909516499589565756753383793998080125165071232140317910880708917414368477930319585713224345586241703538960089588377048023270838450395698917623646654837556124054011784700397196315415041979923778359687545152111655059718006961990186440609454588036329862232531990445883821442518635909212877134474497367702431138917507977283128545885053360665857628397214947463838495849081554623821639921833412395428405488575665432752447137325585168763830506567729788349487049486040780771779645494959821109054275642976547125233126064705 
    n = _sage_const_26655408169980069210647581523602779478383892791339633948356189966966764750165134594036664344616717049933468489628650785388326960151667345490717171048101455362566962665238961659030316534689141077384698564134139632695609188803626466763599399566394268096308569815703206388042056345258250386433839660150434400832811052444460080481324647584218234188638113017330573479354360529764080129533591285518499302216709805065611198775844489705004103428358877462001690093040584862237132523022766091068430370508379474771150405568772531525628897113571198108361167861758593933680578287574630561945653761414928747417980154682790756164343 

    solve_challenge(c, e, n)

if __name__ == "__main__":
    main()

