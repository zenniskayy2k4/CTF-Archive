import pwndbg.dbg
import pwndbg.aglib.memory
import pwndbg.aglib.vmmap
import pwndbg.lib.cache
import time
import gdb
import os


def _delayed_interrupt(timeout_seconds):
    time.sleep(timeout_seconds)
    gdb.execute('interrupt')

def cont_interrupt_after(timeout_seconds):
    gdb.post_event(lambda: _delayed_interrupt(timeout_seconds))
    gdb.execute('continue')

def pwn():
    # Disable pwndbg caching
    pwndbg.lib.cache.IS_CACHING = False

    # TODO: change 127.0.0.1 with challenge domain
    gdb.execute('target remote 127.0.0.1:1234')

    cont_interrupt_after(60)

    # TODO: your exploit here

    # Example usage for printing vmmap
    pages = pwndbg.aglib.vmmap.get()
    print(pages)

    # Example usage for reading memory
    print(pwndbg.aglib.memory.read(pages[0].start, 0x1000))

    os._exit(0)

# How to run:
# pwndbg --command=./exploit.py -ex 'py pwn()'
