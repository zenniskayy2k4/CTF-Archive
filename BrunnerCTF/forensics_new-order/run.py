import base64

# Hàm giải mã XOR mô phỏng lại hàm ufhwSeJFIbBk trong VBA
def decrypt_string(array1, array2):
    """Thực hiện phép XOR giữa hai mảng số và trả về chuỗi ký tự."""
    if len(array1) != len(array2):
        # In ra lỗi nếu có sự không khớp để dễ debug
        print(f"Lỗi độ dài mảng: {len(array1)} vs {len(array2)}")
        return "ERROR"
    return "".join([chr(k ^ v) for k, v in zip(array1, array2)])

# --- PHẦN 1: GIẢI MÃ BIẾN "kfawfa" ---
# Dữ liệu được trích xuất chính xác từ 10 dòng code tạo nên biến kfawfa.
kfawfa_parts = [
    decrypt_string([115, (81 + 3), 96, (((138 - 54) + 1) ^ (98 - 45)), (68 + (83 - 28)), ((26 - 0) ^ 43), (88 ^ (13 - 6)), ((13 + 41) ^ (192 + 25)), (((2 - 1) + 2) ^ (74 + 83)), (139 ^ 62), (78 ^ 52), ((193 - 76) ^ 219), 54, ((279 - 79) + 27), (196 - 4)], [(((13 - 0) + 5) ^ (0 + 0)), (4 + 1), ((28 - 5) ^ ((2 - 0) + 51)), 83, 58, 121, 22, (51 ^ (114 + 43)), (103 ^ ((189 - 73) + 60)), (400 - 156), (36 + 20), (50 + 143), (86 ^ 33), (218 - 47), ((39 + 100) ^ 26)]),
    decrypt_string([189, (4 ^ 45), (224 - 14), (23 + 148), (10 - 4), 188, 173, (55 ^ 74), (101 + 68), 156, (36 + (47 - 18)), (4 - 2), 123, (((18 - 0) + 15) ^ (71 + 167)), 134], [(425 - 173), (73 ^ 4), (80 + 67), ((71 + 24) ^ (182 + 0)), 113, (80 ^ (201 - 28)), 229, 48, (169 ^ (13 + (92 - 40))), ((19 + 17) ^ 247), 38, 67, (17 - 4), 142, 197]),
    decrypt_string([(((4 - 2) + (0 - 0)) ^ (0 + 0)), (67 ^ 21), 51, ((43 + 82) ^ 149), ((0 + 6) ^ (15 + 9)), (71 + 133), ((24 + 7) ^ (186 - 50)), 236, 71, 84, (114 ^ (267 - 75)), (107 + (114 - 54)), (21 ^ (134 - 29)), (139 - 65), (159 ^ (21 + 62))], [(32 + (37 - 11)), ((4 + 16) ^ (1 + (3 - 1))), (124 - 43), (248 - 105), 92, (159 + (39 - 12)), (62 + (207 - 55)), ((14 + 69) ^ 248), (32 + (24 - 12)), 21, 209, (340 - 132), (11 ^ 53), (99 ^ ((22 - 2) + 8)), (120 ^ 245)]),
    decrypt_string([97, (((52 - 23) + 16) ^ 213), (8 ^ 17), ((220 - 100) + 53), (19 + 66), (((7 - 2) + (12 - 5)) ^ (35 - 5)), 254, 254, (87 + 150), (394 - 197), (100 + 26), 113, 160, (428 - 193), (156 + 56)], [(12 + 22), 200, (71 + (27 - 10)), (94 + 110), 20, 80, (207 - 57), (320 - 129), (147 + 23), (((17 - 5) + (18 - 8)) ^ 164), (39 ^ ((21 - 10) + (26 - 13))), 19, 225, (135 + (45 - 10)), (147 + 13)]),
    decrypt_string([27, 179, 206, (((94 - 8) + 13) ^ (256 - 110)), (294 - 85), (60 - 21), (13 + (102 - 45)), (79 + (1 - 0)), (52 + 54), 72, 213, (173 + 13), (53 + 20), (180 + 8), (29 ^ (136 + 71))], [(63 + 27), 244, (107 ^ 252), 176, 136, (137 - 19), (4 ^ (0 - 0)), (104 - 45), ((3 + (3 - 0)) ^ 45), (2 ^ (21 - 7)), 178, ((13 + 43) ^ (253 - 58)), (4 ^ (2 - 1)), ((131 - 63) + (216 - 65)), (127 + 17)]),
    decrypt_string([((0 + 8) ^ 108), (211 - 90), (264 - 127), (9 - 1), (39 + (14 - 4)), 66, 14, ((169 + (16 - 6)) ^ (169 - 64)), 55, (45 - 9), 113, 127, (68 + (241 - 71)), (61 - 10), 115], [18, 56, 206, 127, ((30 + (100 - 24)) ^ (29 - 3)), (11 + (30 - 3)), 95, 152, (172 - 82), (16 ^ ((7 - 0) + 110)), 50, (67 ^ 12), (47 + (248 - 120)), 80, 4]),
    decrypt_string([(7 ^ 18), (18 ^ (31 + 170)), (0 + 5), (113 - 1), ((34 - 1) ^ (195 - 75)), 175, ((80 - 13) + 74), (58 + 104), (240 - 79), 189, (0 ^ 7), (24 + (28 - 5)), ((49 - 22) ^ 91), 148, 13], [87, 179, (84 - 16), (56 - 1), ((57 + 27) ^ 57), (399 - 161), (257 - 42), (434 - 207), (233 - 9), ((60 - 25) ^ ((83 - 32) + 184)), 70, (68 + 35), 35, (((3 - 1) + (10 - 5)) ^ (400 - 190)), (76 ^ (23 + (18 - 6)))]),
    decrypt_string([38, (79 + 151), (((15 - 7) + 12) ^ 46), 102, (0 ^ (0 - 0)), (112 ^ ((20 - 6) + 1)), (98 + 43), 211, (221 - 54), (54 - 16), ((0 + 61) ^ 219), (((9 - 2) + (8 - 1)) ^ (76 - 38)), ((32 - 14) + 104), 159, ((218 - 31) ^ (145 - 55))], [81, (17 ^ ((107 - 22) + 96)), 67, 39, (5 ^ 66), ((8 - 3) ^ (10 - 1)), ((214 - 92) + 82), (12 + (130 - 5)), (34 + 212), ((84 - 14) + 30), 159, (100 ^ ((23 - 10) + 0)), (0 ^ 50), (((95 - 44) + 0) ^ (223 + 2)), ((36 + 10) ^ (8 + 134))]),
    decrypt_string([(4 ^ (19 - 1)), ((0 - 0) + 6), ((6 - 3) + 133), 190, (431 - 178), (((39 - 0) + (27 - 12)) ^ 213), 24, (8 - 0), 171, (157 ^ 60), 172, 174, 16, (51 ^ (88 + 32)), (86 - 4)], [90, 97, 202, (179 + (67 - 33)), (366 - 178), (180 - 16), 77, (43 + 30), 207, (34 ^ 228), (55 + (183 - 1)), 201, (((38 - 9) + 37) ^ 19), 3, 37]),
    decrypt_string([146, (425 - 174), 232, ((150 - 70) + 30), (33 - 8), ((69 - 20) + 79), (24 - 8), (162 - 40), (72 - 29), 74, (46 ^ 230), 46, 161], [((325 - 154) ^ (47 + 73)), (((18 - 7) + 30) ^ (259 - 104)), ((32 - 2) + 139), 44, 105, ((37 - 17) + 173), (42 + (82 - 37)), (36 ^ ((1 - 0) + 10)), ((65 - 31) + 72), (((6 - 2) + 2) ^ (0 + (60 - 19))), 137, ((22 - 4) ^ (7 + 118)), 156])
]
kfawfa = "".join(kfawfa_parts)

# --- PHẦN 2: GIẢI MÃ TOÀN BỘ LỆNH "Run" ---
# Dữ liệu được trích xuất chính xác từ dòng XlKvcoQLrYHaix.Run ...
run_parts = [
    decrypt_string([39, 204, 252, ((82 - 29) ^ 234), (50 ^ (161 - 66)), (179 ^ 12), (10 ^ 126), 220, 244, ((385 - 185) + 41), (((147 - 64) + 68) ^ 70), ((45 - 5) + 27), (306 - 90), 130, ((15 + 28) ^ 106)], [87, (129 ^ (29 + (7 - 2))), (266 - 127), 186, ((11 - 0) + (36 - 16)), (234 - 30), 28, (117 + 68), (5 ^ 157), 157, ((160 - 19) + 114), ((36 - 1) ^ (1 + 4)), ((27 - 11) ^ (46 + (132 - 2))), (119 ^ 144), (44 ^ (64 + 13))]),
    decrypt_string([((244 - 85) ^ (31 + 69)), 140, (196 + 20), 199, 241], [214, (116 + 117), (59 ^ (238 - 97)), (292 - 128), 209]),
    kfawfa,
    decrypt_string([(2 ^ ((0 - 0) + 0)), ((59 - 2) + 156)], [((15 - 7) + 24), (((2 - 1) + 3) ^ 243)]),
    decrypt_string([(175 + 45), (220 - 45)], [254, (210 - 69)])
]
full_command = "".join(run_parts)

print("="*60)
print("BƯỚC 1: LỆNH POWERSHELL SAU KHI GIẢI MÃ LỚP XOR")
print("="*60)
print(full_command)
print("\n")

# --- PHẦN 3: GIẢI MÃ LỚP BASE64 ---
# Tách chuỗi Base64 ra khỏi lệnh powershell
try:
    base64_encoded_part = full_command.split("-enc ")[1]
    
    # PowerShell's -enc flag uses UTF-16LE encoding. We need to decode the base64
    # and then decode the resulting bytes as UTF-16LE.
    decoded_bytes = base64.b64decode(base64_encoded_part)
    final_powershell_script = decoded_bytes.decode('utf-16-le')
    
    print("="*60)
    print("BƯỚC 2: SCRIPT POWERSHELL CUỐI CÙNG SAU KHI GIẢI MÃ BASE64")
    print("="*60)
    print(final_powershell_script)
    print("\n")

    # --- PHẦN 4: TRÍCH XUẤT FLAG TỪ SCRIPT CUỐI CÙNG ---
    # Script này lại chứa 2 chuỗi base64 khác.
    # Dùng regex để tìm tất cả các chuỗi base64 trong ngoặc kép
    import re
    final_b64_strings = re.findall(r'FromBase64String\("([^"]+)"\)', final_powershell_script)
    
    if len(final_b64_strings) == 2:
        part1_b64 = final_b64_strings[0]
        part2_b64 = final_b64_strings[1]
        
        # Giải mã 2 chuỗi cuối cùng
        flag_part1 = base64.b64decode(part1_b64).decode('utf-8')
        flag_part2 = base64.b64decode(part2_b64).decode('utf-8')
        
        # Ghép lại theo logic của script: flag{ + part1 + part2 + }
        final_flag = f"flag{{{flag_part1}{flag_part2}}}"
        
        print("="*60)
        print("BƯỚC 3: FLAG CUỐI CÙNG")
        print("="*60)
        print(final_flag)
        print("\n")
        
except Exception as e:
    print(f"Đã xảy ra lỗi trong quá trình giải mã cuối cùng: {e}")